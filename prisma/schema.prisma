// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // ⬅️ CORRECCIÓN: Añadir la clave "provider"
  url      = env("DATABASE_URL")
}

// ------------------------------------------------------------------
// 1. Modelos de Autenticación (Auth.js / NextAuth.js)
// ------------------------------------------------------------------
model User {
  id              String          @id @default(cuid())
  email           String          @unique // Campo de login
  name            String?
  passwordHash    String?         // Hash de la contraseña (para login por credenciales)
  role            Role            @default(STUDENT)
  
  // Relaciones de Auth.js
  sessions        Session[]
  accounts        Account[]

  // Relaciones de KLINIK-MAT
  results         StudentResult[] // Futuro modelo para guardar el historial de puntajes

  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ------------------------------------------------------------------
// 2. Modelos de Contenido Educativo (KLINIK-MAT)
// ------------------------------------------------------------------
model Case {
  id              String         @id @default(cuid())
  title           String         // Nombre del caso (Ej: Embarazo Ectópico)
  area            String         // (Ej: Obstetricia, Ginecología)
  difficulty      Int            // 1 (Fácil) - 5 (Difícil)
  summary         String?        
  isPublic        Boolean        @default(false)
  vignette        String?        // Descripción narrativa larga

  questions       Question[]     @relation("CaseQuestions")
  norms           MinsalNorm[]   @relation("CaseNorms")

  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@map("cases")
}

model Question {
  id              String         @id @default(cuid())
  order           Int            // Orden de aparición dentro del caso
  text            String         // Texto de la pregunta

  case            Case           @relation("CaseQuestions", fields: [caseId], references: [id])
  caseId          String
  
  options         Option[]       @relation("QuestionOptions")

  @@map("questions")
}

model Option {
  id              String         @id @default(cuid())
  text            String
  isCorrect       Boolean        @default(false) // La clave para el grading
  feedback        String?        // Explicación para el razonamiento clínico

  question        Question       @relation("QuestionOptions", fields: [questionId], references: [id])
  questionId      String

  @@map("options")
}

model MinsalNorm {
  id              String         @id @default(cuid())
  name            String         
  code            String         @unique 
  cases           Case[]         @relation("CaseNorms")

  @@map("minsal_norms")
}

// ------------------------------------------------------------------
// 3. ENUMS y Modelo de Resultados (Para Futuras Tareas)
// ------------------------------------------------------------------
enum Role {
  STUDENT // Puede resolver casos
  EDITOR  // Puede crear y editar casos
  ADMIN   // Acceso total
}

// Modelo futuro para almacenar el resultado de un estudiante en un caso
model StudentResult {
    id        String   @id @default(cuid())
    userId    String
    caseId    String
    score     Int      // Puntaje final (ej: 8/10)
    completedAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id])

    @@unique([userId, caseId])
    @@map("student_results")
}